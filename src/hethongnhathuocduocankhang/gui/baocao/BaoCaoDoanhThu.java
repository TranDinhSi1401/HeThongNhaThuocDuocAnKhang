/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package hethongnhathuocduocankhang.gui.baocao;

import hethongnhathuocduocankhang.dao.HoaDonDAO;
import hethongnhathuocduocankhang.dao.PhieuTraHangDAO;
import hethongnhathuocduocankhang.dao.BaoCaoDoanhThuDAO;
import hethongnhathuocduocankhang.entity.HoaDon;
import hethongnhathuocduocankhang.entity.PhieuTraHang;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.text.DecimalFormat;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.Date;
import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.table.DefaultTableModel;
import org.apache.poi.ss.usermodel.BorderStyle;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.HorizontalAlignment;
import org.apache.poi.ss.usermodel.IndexedColors;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.jdesktop.swingx.JXDatePicker;

/**
 *
 * @author MINH KHANG
 */
public class BaoCaoDoanhThu extends javax.swing.JPanel {

    private JXDatePicker datePickerTuNgay;
    private JXDatePicker datePickerDenNgay;
    private JComboBox<Integer> cmbTuThang;
    private JComboBox<Integer> cmbDenThang;
    private JComboBox<Integer> cmbTuQuy;
    private JComboBox<Integer> cmbDenQuy;
    private JComboBox<Integer> cmbTuNam;
    private JComboBox<Integer> cmbDenNam;
    private JComboBox<String> cmbLoaiThongKe;
    private JButton btnXemBaoCao;
    private JButton btnXuatFile;
    private JTable table;
    private DefaultTableModel model;
    private JLabel lblTongDoanhThu;
    private JScrollPane scrollPane;
    private JPanel pnlCenter;

    /**
     * Creates new form BaoCaoDoanhThu
     */
    public BaoCaoDoanhThu() {
        initComponents();
        setupUI();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 400, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 300, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents

    private void setupUI() {
        this.setLayout(new BorderLayout(10, 10));
        this.setBorder(new EmptyBorder(10, 10, 10, 10));

        // Panel NORTH (B·ªô l·ªçc b√°o c√°o)
        JPanel pnlNorth = new JPanel();
        pnlNorth.setLayout(new BorderLayout());

        JPanel pnlFilter = new JPanel(new FlowLayout(FlowLayout.LEFT, 15, 5));
        pnlFilter.setBorder(new EmptyBorder(0, 0, 10, 0));

        Font fontLabel = new Font("Arial", Font.BOLD, 14);
        Font fontInput = new Font("Arial", Font.PLAIN, 14);
        
        JLabel lblTuThang = new JLabel("T·ª´ th√°ng:");
        lblTuThang.setFont(fontLabel);

        JLabel lblDenThang = new JLabel("ƒê·∫øn th√°ng:");
        lblDenThang.setFont(fontLabel);

        JLabel lblTuQuy = new JLabel("T·ª´ qu√Ω:");
        lblTuQuy.setFont(fontLabel);

        JLabel lblDenQuy = new JLabel("ƒê·∫øn qu√Ω:");
        lblDenQuy.setFont(fontLabel);

        JLabel lblTuNam = new JLabel("T·ª´ nƒÉm:");
        lblTuNam.setFont(fontLabel);

        JLabel lblDenNam = new JLabel("ƒê·∫øn nƒÉm:");
        lblDenNam.setFont(fontLabel);

        JLabel lblTuNgay = new JLabel("T·ª´ ng√†y:");
        lblTuNgay.setFont(fontLabel);
        datePickerTuNgay = new JXDatePicker();
        datePickerTuNgay.setFont(fontInput);
        datePickerTuNgay.setDate(java.util.Date.from(LocalDate.now().minusMonths(1).atStartOfDay(java.time.ZoneId.systemDefault()).toInstant())); // M·∫∑c ƒë·ªãnh 1 th√°ng tr∆∞·ªõc

        // NgƒÉn ch·ªçn ng√†y l·ªõn h∆°n ng√†y hi·ªán t·∫°i
        PropertyChangeListener dateListenerTuNgay = evt -> {
            if ("date".equals(evt.getPropertyName())) {
                java.util.Date selectedDate = (java.util.Date) evt.getNewValue();
                if (selectedDate != null) {
                    LocalDate selectedLocalDate = LocalDate.ofInstant(selectedDate.toInstant(), java.time.ZoneId.systemDefault());
                    if (selectedLocalDate.isAfter(LocalDate.now())) {
                        datePickerTuNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant()));
                    }
                }
            }
        };
        datePickerTuNgay.addPropertyChangeListener(dateListenerTuNgay);

        JLabel lblDenNgay = new JLabel("ƒê·∫øn ng√†y:");
        lblDenNgay.setFont(fontLabel);
        datePickerDenNgay = new JXDatePicker();
        datePickerDenNgay.setFont(fontInput);
        datePickerDenNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant())); // M·∫∑c ƒë·ªãnh h√¥m nay

        // NgƒÉn ch·ªçn ng√†y l·ªõn h∆°n ng√†y hi·ªán t·∫°i
        PropertyChangeListener dateListenerDenNgay = evt -> {
            if ("date".equals(evt.getPropertyName())) {
                java.util.Date selectedDate = (java.util.Date) evt.getNewValue();
                if (selectedDate != null) {
                    LocalDate selectedLocalDate = LocalDate.ofInstant(selectedDate.toInstant(), java.time.ZoneId.systemDefault());
                    if (selectedLocalDate.isAfter(LocalDate.now())) {
                        datePickerDenNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant()));
                    }
                }
            }
        };
        datePickerDenNgay.addPropertyChangeListener(dateListenerDenNgay);

        JLabel lblLoai = new JLabel("Lo·∫°i th·ªëng k√™:");
        lblLoai.setFont(fontLabel);
        String[] arrLoai = {"Theo ng√†y", "Theo th√°ng", "Theo qu√Ω", "Theo nƒÉm"};
        cmbLoaiThongKe = new JComboBox<>(arrLoai);
        cmbLoaiThongKe.setFont(fontInput);
        cmbLoaiThongKe.setPreferredSize(new Dimension(120, 30));
        cmbLoaiThongKe.addActionListener(e -> {
            String loai = (String) cmbLoaiThongKe.getSelectedItem();
            boolean isTheoNgay = "Theo ng√†y".equals(loai);
            boolean isTheoThang = "Theo th√°ng".equals(loai);
            boolean isTheoQuy = "Theo qu√Ω".equals(loai);
            boolean isTheoNam = "Theo nƒÉm".equals(loai);

            lblTuNgay.setVisible(isTheoNgay);
            datePickerTuNgay.setVisible(isTheoNgay);
            lblDenNgay.setVisible(isTheoNgay);
            datePickerDenNgay.setVisible(isTheoNgay);

            lblTuThang.setVisible(isTheoThang);
            cmbTuThang.setVisible(isTheoThang);
            lblDenThang.setVisible(isTheoThang);
            cmbDenThang.setVisible(isTheoThang);

            lblTuQuy.setVisible(isTheoQuy);
            cmbTuQuy.setVisible(isTheoQuy);
            lblDenQuy.setVisible(isTheoQuy);
            cmbDenQuy.setVisible(isTheoQuy);

            lblTuNam.setVisible(isTheoNam);
            cmbTuNam.setVisible(isTheoNam);
            lblDenNam.setVisible(isTheoNam);
            cmbDenNam.setVisible(isTheoNam);

            pnlFilter.revalidate();
            pnlFilter.repaint();

            // üëâ Reset table v√† t·ªïng doanh thu
            model.setRowCount(0);
            lblTongDoanhThu.setText("T·ªïng doanh thu: 0 VND");
        });

        // M·∫∑c ƒë·ªãnh ch·ªçn "Theo ng√†y" v√† hi·ªán JDatePicker
        // cmbLoaiThongKe.setSelectedItem("Theo ng√†y");
        // lblTuNgay.setVisible(true);
        // datePickerTuNgay.setVisible(true);
        // lblDenNgay.setVisible(true);
        // datePickerDenNgay.setVisible(true);

        // T·∫°o combo th√°ng
        cmbTuThang = new JComboBox<>();
        for (int i = 1; i <= 12; i++) cmbTuThang.addItem(i);
        cmbTuThang.setFont(fontInput);
        cmbTuThang.setPreferredSize(new Dimension(80, 30));

        cmbDenThang = new JComboBox<>();
        for (int i = 1; i <= 12; i++) cmbDenThang.addItem(i);
        cmbDenThang.setFont(fontInput);
        cmbDenThang.setPreferredSize(new Dimension(80, 30));

        // T·∫°o combo qu√Ω
        cmbTuQuy = new JComboBox<>();
        for (int i = 1; i <= 4; i++) cmbTuQuy.addItem(i);
        cmbTuQuy.setFont(fontInput);
        cmbTuQuy.setPreferredSize(new Dimension(80, 30));

        cmbDenQuy = new JComboBox<>();
        for (int i = 1; i <= 4; i++) cmbDenQuy.addItem(i);
        cmbDenQuy.setFont(fontInput);
        cmbDenQuy.setPreferredSize(new Dimension(80, 30));

        int minYear = 2025;
        int maxYear = LocalDate.now().getYear();
        cmbTuNam = new JComboBox<>();
        for (int i = minYear; i <= maxYear; i++) cmbTuNam.addItem(i);
        cmbTuNam.setFont(fontInput);
        cmbTuNam.setPreferredSize(new Dimension(80, 30));

        cmbDenNam = new JComboBox<>();
        for (int i = minYear; i <= maxYear; i++) cmbDenNam.addItem(i);
        cmbDenNam.setFont(fontInput);
        cmbDenNam.setPreferredSize(new Dimension(80, 30));

        // ·∫®n t·∫•t c·∫£ ban ƒë·∫ßu
        datePickerTuNgay.setVisible(false);
        datePickerDenNgay.setVisible(false);
        cmbTuThang.setVisible(false);
        cmbDenThang.setVisible(false);
        cmbTuQuy.setVisible(false);
        cmbDenQuy.setVisible(false);
        cmbTuNam.setVisible(false);
        cmbDenNam.setVisible(false);

        btnXemBaoCao = new JButton("Xem b√°o c√°o");
        btnXemBaoCao.setFont(fontLabel);
        btnXemBaoCao.setBackground(new Color(25,118,210));
        btnXemBaoCao.setForeground(new Color(255,255,255));
        btnXemBaoCao.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                xemBaoCao();
            }
        });

        btnXuatFile = new JButton("Xu·∫•t file b√°o c√°o");
        btnXuatFile.setFont(fontLabel);
        btnXuatFile.setBackground(new Color(0,203,0));
        btnXuatFile.setForeground(new Color(255,255,255));
        btnXuatFile.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                JFileChooser fileChooser = new JFileChooser();
                fileChooser.setDialogTitle("Ch·ªçn n∆°i l∆∞u b√°o c√°o Excel");
                fileChooser.setSelectedFile(new File("BaoCao.xlsx"));
                int userSelection = fileChooser.showSaveDialog(null);

                if (userSelection == JFileChooser.APPROVE_OPTION) {
                    File fileToSave = fileChooser.getSelectedFile();
                    // G·ªçi ph∆∞∆°ng th·ª©c xu·∫•t b√°o c√°o
                    xuatFileBaoCao(fileToSave);
                }

            }
        });
        // TODO: Th√™m logic xu·∫•t file sau

        pnlFilter.add(lblTuNgay);
        pnlFilter.add(datePickerTuNgay);
        pnlFilter.add(lblDenNgay);
        pnlFilter.add(datePickerDenNgay);
        
        pnlFilter.add(lblTuThang);
        pnlFilter.add(cmbTuThang);
        pnlFilter.add(lblDenThang);
        pnlFilter.add(cmbDenThang);

        pnlFilter.add(lblTuQuy);
        pnlFilter.add(cmbTuQuy);
        pnlFilter.add(lblDenQuy);
        pnlFilter.add(cmbDenQuy);

        pnlFilter.add(lblTuNam);
        pnlFilter.add(cmbTuNam);
        pnlFilter.add(lblDenNam);
        pnlFilter.add(cmbDenNam);
        
        pnlFilter.add(lblLoai);
        pnlFilter.add(cmbLoaiThongKe);
        pnlFilter.add(btnXemBaoCao);
        pnlFilter.add(btnXuatFile);

        pnlNorth.add(pnlFilter, BorderLayout.CENTER);

        // Panel CENTER (Table)
        pnlCenter = new JPanel(new BorderLayout());
        String[] columnNames = {"Th·ªùi gian", "T·ªïng h√≥a ƒë∆°n", "T·ªïng phi·∫øu tr·∫£", "Doanh thu"};
        model = new DefaultTableModel(columnNames, 0);
        table = new JTable(model);
        table.setFont(new Font("Arial", Font.PLAIN, 14));
        table.getTableHeader().setFont(new Font("Arial", Font.BOLD, 14));
        scrollPane = new JScrollPane(table);
        pnlCenter.add(scrollPane, BorderLayout.CENTER);

        // Panel SOUTH (T·ªïng doanh thu)
        JPanel pnlSouth = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        lblTongDoanhThu = new JLabel("T·ªïng doanh thu: 0 VND");
        lblTongDoanhThu.setFont(new Font("Arial", Font.BOLD, 16));
        pnlSouth.add(lblTongDoanhThu);

        // Th√™m v√†o main panel
        this.add(pnlNorth, BorderLayout.NORTH);
        this.add(pnlCenter, BorderLayout.CENTER);
        this.add(pnlSouth, BorderLayout.SOUTH);

        // X√≥a c√°c component c≈© n·∫øu c√≥

        // M·∫∑c ƒë·ªãnh ch·ªçn "Theo ng√†y" v√† hi·ªán JDatePicker
        cmbLoaiThongKe.setSelectedItem("Theo ng√†y");
        lblTuNgay.setVisible(true);
        datePickerTuNgay.setVisible(true);
        lblDenNgay.setVisible(true);
        datePickerDenNgay.setVisible(true);
    }

    private void xemBaoCao() {
        showLoadingDialog();

        // 1. S·ª≠a SwingWorker ƒë·ªÉ tr·∫£ v·ªÅ Map (Key, Value) thay v√¨ Void
        SwingWorker<Map<String, double[]>, Void> worker = new SwingWorker<>() {

            // Khai b√°o bi·∫øn n√†y ·ªü ƒë√¢y ƒë·ªÉ d√πng chung cho c·∫£ doInBackground v√† done
            List<String> allKeys = new ArrayList<>();

            @Override
            protected Map<String, double[]> doInBackground() throws Exception {
                String loaiThongKe = (String) cmbLoaiThongKe.getSelectedItem();

                // Khai b√°o bi·∫øn ng√†y ƒë·ªÉ g·ª≠i xu·ªëng DB
                java.util.Date dbTuNgay = null;
                java.util.Date dbDenNgay = null;

                // --- X·ª¨ L√ù NG√ÄY TH√ÅNG (Logic gi·ªØ nguy√™n nh∆∞ c≈©) ---
                if ("Theo ng√†y".equals(loaiThongKe)) {
                    dbTuNgay = datePickerTuNgay.getDate();
                    dbDenNgay = datePickerDenNgay.getDate();

                    if (dbTuNgay.after(dbDenNgay)) {
                        throw new Exception("T·ª´ ng√†y ph·∫£i b√© h∆°n ƒë·∫øn ng√†y");
                    }

                    LocalDate startDate = dbTuNgay.toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                    LocalDate endDate = dbDenNgay.toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                    for (LocalDate date = startDate; !date.isAfter(endDate); date = date.plusDays(1)) {
                        allKeys.add(date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy")));
                    }

                } else if ("Theo th√°ng".equals(loaiThongKe)) {
                    int tuThang = (Integer) cmbTuThang.getSelectedItem();
                    int tuNam = (Integer) cmbTuNam.getSelectedItem();
                    int denThang = (Integer) cmbDenThang.getSelectedItem();
                    int denNam = (Integer) cmbDenNam.getSelectedItem();

                    dbTuNgay = java.sql.Date.valueOf(LocalDate.of(tuNam, tuThang, 1));
                    LocalDate lastDayOfMonth = LocalDate.of(denNam, denThang, 1).plusMonths(1).minusDays(1);
                    dbDenNgay = java.sql.Date.valueOf(lastDayOfMonth);

                    for (int nam = tuNam; nam <= denNam; nam++) {
                        int startThang = (nam == tuNam) ? tuThang : 1;
                        int endThang = (nam == denNam) ? denThang : 12;
                        for (int thang = startThang; thang <= endThang; thang++) {
                            allKeys.add(String.format("%02d/%d", thang, nam));
                        }
                    }
                } else if ("Theo qu√Ω".equals(loaiThongKe)) {
                    int tuQuy = (Integer) cmbTuQuy.getSelectedItem();
                    int tuNam = (Integer) cmbTuNam.getSelectedItem();
                    int denQuy = (Integer) cmbDenQuy.getSelectedItem();
                    int denNam = (Integer) cmbDenNam.getSelectedItem();

                    int startMonth = (tuQuy - 1) * 3 + 1;
                    dbTuNgay = java.sql.Date.valueOf(LocalDate.of(tuNam, startMonth, 1));

                    int endMonth = denQuy * 3;
                    LocalDate lastDayOfQuarter = LocalDate.of(denNam, endMonth, 1).plusMonths(1).minusDays(1);
                    dbDenNgay = java.sql.Date.valueOf(lastDayOfQuarter);

                    for (int nam = tuNam; nam <= denNam; nam++) {
                        int startQuy = (nam == tuNam) ? tuQuy : 1;
                        int endQuy = (nam == denNam) ? denQuy : 4;
                        for (int quy = startQuy; quy <= endQuy; quy++) {
                            allKeys.add("Qu√Ω " + quy + " nƒÉm " + nam);
                        }
                    }
                } else if ("Theo nƒÉm".equals(loaiThongKe)) {
                    int tuNam = (Integer) cmbTuNam.getSelectedItem();
                    int denNam = (Integer) cmbDenNam.getSelectedItem();

                    dbTuNgay = java.sql.Date.valueOf(LocalDate.of(tuNam, 1, 1));
                    dbDenNgay = java.sql.Date.valueOf(LocalDate.of(denNam, 12, 31));

                    for (int nam = tuNam; nam <= denNam; nam++) {
                        allKeys.add("NƒÉm " + nam);
                    }
                }

                // --- G·ªåI DAO ---
                // Ch·ªâ l·∫•y d·ªØ li·ªáu, KH√îNG c·∫≠p nh·∫≠t giao di·ªán ·ªü ƒë√¢y
                BaoCaoDoanhThuDAO thongKeDAO = new BaoCaoDoanhThuDAO();
                return thongKeDAO.getDoanhThuMap(dbTuNgay, dbDenNgay, loaiThongKe);
            }

            @Override
            protected void done() {
                try {
                    // L·∫•y k·∫øt qu·∫£ t·ª´ doInBackground (n·∫øu c√≥ l·ªói n√≥ s·∫Ω n√©m ra ·ªü ƒë√¢y)
                    Map<String, double[]> dataMap = get();

                    // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN ·ªû ƒê√ÇY (An to√†n tuy·ªát ƒë·ªëi) ---
                    model.setRowCount(0);
                    double tongDoanhThuToanBo = 0;

                    for (String key : allKeys) {
                        double tongHD = 0;
                        double tongPT = 0;

                        if (dataMap.containsKey(key)) {
                            double[] values = dataMap.get(key);
                            tongHD = values[0];
                            tongPT = values[1];
                        }

                        double doanhThu = tongHD - tongPT;

                        model.addRow(new Object[]{key, dinhDangTien(tongHD), dinhDangTien(tongPT), dinhDangTien(doanhThu)});
                        tongDoanhThuToanBo += doanhThu;
                    }
                    lblTongDoanhThu.setText("T·ªïng doanh thu: " + dinhDangTien(tongDoanhThuToanBo));

                } catch (Exception e) {
                    e.printStackTrace();
                    JOptionPane.showMessageDialog(null, "C√≥ l·ªói x·∫£y ra: " + e.getMessage());
                } finally {
                    // --- QUAN TR·ªåNG: LU√îN T·∫ÆT LOADING D√ô C√ì L·ªñI HAY KH√îNG ---
                    disposeLoadingDialog();
                }
            }
        };
        worker.execute();
    }

    // ƒê·ªãnh d·∫°ng ti·ªÅn nh∆∞ TraHangGUI
    private String dinhDangTien(double thanhTien) {
        DecimalFormat formatter = new DecimalFormat("#,###");
        return formatter.format(thanhTien) + " VNƒê";
    }

    // Get key cho HoaDon ho·∫∑c PhieuTraHang
    private String getKey(HoaDon hd, String loaiThongKe) {
        LocalDate date = hd.getNgayLapHoaDon().toLocalDate();
        if ("Theo ng√†y".equals(loaiThongKe)) {
            return date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy"));
        } else if ("Theo th√°ng".equals(loaiThongKe)) {
            return String.format("%02d/%d", date.getMonthValue(), date.getYear());
        } else if ("Theo qu√Ω".equals(loaiThongKe)) {
            int quy = (date.getMonthValue() - 1) / 3 + 1;
            return "Qu√Ω " + quy + " nƒÉm " + date.getYear();
        } else if ("Theo nƒÉm".equals(loaiThongKe)) {
            return "NƒÉm " + date.getYear();
        }
        return "";
    }

    private String getKey(PhieuTraHang pt, String loaiThongKe) {
        LocalDate date = pt.getNgayLapPhieuTraHang().toLocalDate();
        if ("Theo ng√†y".equals(loaiThongKe)) {
            return date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy"));
        } else if ("Theo th√°ng".equals(loaiThongKe)) {
            return String.format("%02d/%d", date.getMonthValue(), date.getYear());
        } else if ("Theo qu√Ω".equals(loaiThongKe)) {
            int quy = (date.getMonthValue() - 1) / 3 + 1;
            return "Qu√Ω " + quy + " nƒÉm " + date.getYear();
        } else if ("Theo nƒÉm".equals(loaiThongKe)) {
            return "NƒÉm " + date.getYear();
        }
        return "";
    }

    private JDialog loadingDialog;

    private void showLoadingDialog() {
        loadingDialog = new JDialog(
            (java.awt.Frame) SwingUtilities.getWindowAncestor(this),
            "ƒêang t·∫£i", 
            false
        );
        loadingDialog.setDefaultCloseOperation(JDialog.DO_NOTHING_ON_CLOSE);

        // Panel ch·ª©a label + progress bar
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        JLabel label = new JLabel("ƒêang th·ªëng k√™ d·ªØ li·ªáu...", SwingConstants.CENTER);
        label.setFont(new Font("Arial", Font.BOLD, 14));
        panel.add(label, BorderLayout.NORTH);

        // Thanh loading
        JProgressBar progressBar = new JProgressBar();
        progressBar.setIndeterminate(true); // ch·∫°y qua l·∫°i
        panel.add(progressBar, BorderLayout.CENTER);

        loadingDialog.getContentPane().add(panel);
        loadingDialog.pack(); // t·ª± ƒë·ªông t√≠nh k√≠ch th∆∞·ªõc
        loadingDialog.setLocationRelativeTo(this);

        this.setEnabled(false);
        loadingDialog.setVisible(true);
    }

    private void disposeLoadingDialog() {
        if (loadingDialog != null) {
            loadingDialog.dispose();
            loadingDialog = null;
        }
        this.setEnabled(true);
    }
    
    private void xuatFileBaoCao(File fileToSave) {
        // 1. Ki·ªÉm tra b·∫£ng c√≥ d·ªØ li·ªáu kh√¥ng
        if (model.getRowCount() == 0) {
            JOptionPane.showMessageDialog(this, "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t. Vui l√≤ng ·∫•n 'Xem b√°o c√°o' tr∆∞·ªõc!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // 2. T·ª± ƒë·ªông th√™m ƒëu√¥i .xlsx n·∫øu ng∆∞·ªùi d√πng qu√™n
        String path = fileToSave.getAbsolutePath();
        if (!path.toLowerCase().endsWith(".xlsx")) {
            fileToSave = new File(path + ".xlsx");
        }

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("B√°o c√°o");

            String loaiThongKe = (String) cmbLoaiThongKe.getSelectedItem();

            // --- STYLE ---
            CellStyle headerStyle = workbook.createCellStyle();
            org.apache.poi.ss.usermodel.Font headerFont = workbook.createFont();
            headerFont.setBold(true);
            headerFont.setFontHeightInPoints((short) 16);
            headerStyle.setFont(headerFont);
            headerStyle.setAlignment(HorizontalAlignment.CENTER);

            CellStyle borderStyle = workbook.createCellStyle();
            borderStyle.setBorderTop(BorderStyle.THIN);
            borderStyle.setBorderBottom(BorderStyle.THIN);
            borderStyle.setBorderLeft(BorderStyle.THIN);
            borderStyle.setBorderRight(BorderStyle.THIN);

            // --- ROW 0: TI√äU ƒê·ªÄ ---
            Row headerRow = sheet.createRow(0);
            Cell headerCell = headerRow.createCell(0);
            headerCell.setCellValue("B√ÅO C√ÅO DOANH THU " + loaiThongKe.toUpperCase());
            headerCell.setCellStyle(headerStyle);

            // Merge cell ti√™u ƒë·ªÅ (tr√°nh l·ªói n·∫øu c·ªôt < 1)
            if (model.getColumnCount() > 0) {
                sheet.addMergedRegion(new CellRangeAddress(0, 0, 0, model.getColumnCount() - 1));
            }

            // --- ROW 2: TH·ªúI GIAN TH·ªêNG K√ä ---
            Row infoRow = sheet.createRow(2);
            Cell infoCell = infoRow.createCell(0);
            String thoiGianText = "";

            if ("Theo ng√†y".equals(loaiThongKe)) {
                DateTimeFormatter dtf = DateTimeFormatter.ofPattern("dd/MM/yyyy");
                LocalDate d1 = datePickerTuNgay.getDate().toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                LocalDate d2 = datePickerDenNgay.getDate().toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                thoiGianText = "T·ª´ ng√†y " + d1.format(dtf) + " ƒë·∫øn ng√†y " + d2.format(dtf);
            } else if ("Theo th√°ng".equals(loaiThongKe)) {
                thoiGianText = "T·ª´ th√°ng " + cmbTuThang.getSelectedItem() + "/" + cmbTuNam.getSelectedItem() + 
                               " ƒë·∫øn th√°ng " + cmbDenThang.getSelectedItem() + "/" + cmbDenNam.getSelectedItem();
            } else if ("Theo qu√Ω".equals(loaiThongKe)) {
                thoiGianText = "T·ª´ qu√Ω " + cmbTuQuy.getSelectedItem() + " nƒÉm " + cmbTuNam.getSelectedItem() + 
                               " ƒë·∫øn qu√Ω " + cmbDenQuy.getSelectedItem() + " nƒÉm " + cmbDenNam.getSelectedItem();
            } else if ("Theo nƒÉm".equals(loaiThongKe)) {
                thoiGianText = "T·ª´ nƒÉm " + cmbTuNam.getSelectedItem() + " ƒë·∫øn nƒÉm " + cmbDenNam.getSelectedItem();
            }

            infoCell.setCellValue(thoiGianText);
            if (model.getColumnCount() > 0) {
                sheet.addMergedRegion(new CellRangeAddress(2, 2, 0, model.getColumnCount() - 1));
            }

            // --- ROW 3: NG√ÄY L·∫¨P ---
            Row timeRow = sheet.createRow(3);
            Cell timeCell = timeRow.createCell(0);
            String ngayLap = java.time.LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"));
            timeCell.setCellValue("Th·ªùi gian l·∫≠p b√°o c√°o: " + ngayLap);
            if (model.getColumnCount() > 0) {
                sheet.addMergedRegion(new CellRangeAddress(3, 3, 0, model.getColumnCount() - 1));
            }

            // --- ROW 5: HEADER B·∫¢NG ---
            Row tableHeaderRow = sheet.createRow(5);
            for (int i = 0; i < model.getColumnCount(); i++) {
                Cell cell = tableHeaderRow.createCell(i);
                cell.setCellValue(model.getColumnName(i));
                cell.setCellStyle(borderStyle);
            }

            // --- DATA ROWS ---
            for (int r = 0; r < model.getRowCount(); r++) {
                Row row = sheet.createRow(r + 6);
                for (int c = 0; c < model.getColumnCount(); c++) {
                    Object value = model.getValueAt(r, c);
                    Cell cell = row.createCell(c);
                    cell.setCellValue(value != null ? value.toString() : "");
                    cell.setCellStyle(borderStyle);
                }
            }

            // --- FOOTER: T·ªîNG DOANH THU ---
            int footerRowIndex = model.getRowCount() + 7;
            Row footerRow = sheet.createRow(footerRowIndex);
            Cell footerCell = footerRow.createCell(0);
            footerCell.setCellValue(lblTongDoanhThu.getText());
            CellStyle footerStyle = workbook.createCellStyle();
            org.apache.poi.ss.usermodel.Font footerFont = workbook.createFont();
            footerFont.setBold(true);
            footerFont.setColor(IndexedColors.RED.getIndex());
            footerStyle.setFont(footerFont);
            footerCell.setCellStyle(footerStyle);

            if (model.getColumnCount() > 0) {
                sheet.addMergedRegion(new CellRangeAddress(footerRowIndex, footerRowIndex, 0, model.getColumnCount() - 1));
            }

            // Auto resize column
            for (int i = 0; i < model.getColumnCount(); i++) {
                sheet.autoSizeColumn(i);
            }

            // Ghi file
            try (FileOutputStream fos = new FileOutputStream(fileToSave)) {
                workbook.write(fos);
                JOptionPane.showMessageDialog(this, "Xu·∫•t b√°o c√°o th√†nh c√¥ng!\nL∆∞u t·∫°i: " + fileToSave.getAbsolutePath());

                // T√πy ch·ªçn: M·ªü file ngay sau khi xu·∫•t
                // Desktop.getDesktop().open(fileToSave); 
            }

        } catch (java.io.FileNotFoundException ex) {
            JOptionPane.showMessageDialog(this, "L·ªói: File ƒëang ƒë∆∞·ª£c m·ªü b·ªüi ch∆∞∆°ng tr√¨nh kh√°c.\nVui l√≤ng ƒë√≥ng file Excel l·∫°i v√† th·ª≠ l·∫°i!", "L·ªói file", JOptionPane.ERROR_MESSAGE);
        } catch (IOException ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "L·ªói ghi file: " + ex.getMessage(), "L·ªói IO", JOptionPane.ERROR_MESSAGE);
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "L·ªói kh√¥ng x√°c ƒë·ªãnh: " + ex.getMessage(), "L·ªói", JOptionPane.ERROR_MESSAGE);
        }
    }
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables
}
