/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package hethongnhathuocduocankhang.gui.baocao;

import hethongnhathuocduocankhang.dao.HoaDonDAO;
import hethongnhathuocduocankhang.dao.PhieuTraHangDAO;
import hethongnhathuocduocankhang.entity.HoaDon;
import hethongnhathuocduocankhang.entity.PhieuTraHang;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileOutputStream;
import java.text.DecimalFormat;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.Date;
import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.table.DefaultTableModel;
import org.apache.poi.ss.usermodel.BorderStyle;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.HorizontalAlignment;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.jdesktop.swingx.JXDatePicker;

/**
 *
 * @author MINH KHANG
 */
public class BaoCaoDoanhThu extends javax.swing.JPanel {

    private JXDatePicker datePickerTuNgay;
    private JXDatePicker datePickerDenNgay;
    private JComboBox<Integer> cmbTuThang;
    private JComboBox<Integer> cmbDenThang;
    private JComboBox<Integer> cmbTuQuy;
    private JComboBox<Integer> cmbDenQuy;
    private JComboBox<Integer> cmbTuNam;
    private JComboBox<Integer> cmbDenNam;
    private JComboBox<String> cmbLoaiThongKe;
    private JButton btnXemBaoCao;
    private JButton btnXuatFile;
    private JTable table;
    private DefaultTableModel model;
    private JLabel lblTongDoanhThu;
    private JScrollPane scrollPane;
    private JPanel pnlCenter;

    /**
     * Creates new form BaoCaoDoanhThu
     */
    public BaoCaoDoanhThu() {
        initComponents();
        setupUI();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 400, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 300, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents

    private void setupUI() {
        this.setLayout(new BorderLayout(10, 10));
        this.setBorder(new EmptyBorder(10, 10, 10, 10));

        // Panel NORTH (B·ªô l·ªçc b√°o c√°o)
        JPanel pnlNorth = new JPanel();
        pnlNorth.setLayout(new BorderLayout());

        JPanel pnlFilter = new JPanel(new FlowLayout(FlowLayout.LEFT, 15, 5));
        pnlFilter.setBorder(new EmptyBorder(0, 0, 10, 0));

        Font fontLabel = new Font("Arial", Font.BOLD, 14);
        Font fontInput = new Font("Arial", Font.PLAIN, 14);
        
        JLabel lblTuThang = new JLabel("T·ª´ th√°ng:");
        lblTuThang.setFont(fontLabel);

        JLabel lblDenThang = new JLabel("ƒê·∫øn th√°ng:");
        lblDenThang.setFont(fontLabel);

        JLabel lblTuQuy = new JLabel("T·ª´ qu√Ω:");
        lblTuQuy.setFont(fontLabel);

        JLabel lblDenQuy = new JLabel("ƒê·∫øn qu√Ω:");
        lblDenQuy.setFont(fontLabel);

        JLabel lblTuNam = new JLabel("T·ª´ nƒÉm:");
        lblTuNam.setFont(fontLabel);

        JLabel lblDenNam = new JLabel("ƒê·∫øn nƒÉm:");
        lblDenNam.setFont(fontLabel);

        JLabel lblTuNgay = new JLabel("T·ª´ ng√†y:");
        lblTuNgay.setFont(fontLabel);
        datePickerTuNgay = new JXDatePicker();
        datePickerTuNgay.setFont(fontInput);
        datePickerTuNgay.setDate(java.util.Date.from(LocalDate.now().minusMonths(1).atStartOfDay(java.time.ZoneId.systemDefault()).toInstant())); // M·∫∑c ƒë·ªãnh 1 th√°ng tr∆∞·ªõc

        // NgƒÉn ch·ªçn ng√†y l·ªõn h∆°n ng√†y hi·ªán t·∫°i
        PropertyChangeListener dateListenerTuNgay = evt -> {
            if ("date".equals(evt.getPropertyName())) {
                java.util.Date selectedDate = (java.util.Date) evt.getNewValue();
                if (selectedDate != null) {
                    LocalDate selectedLocalDate = LocalDate.ofInstant(selectedDate.toInstant(), java.time.ZoneId.systemDefault());
                    if (selectedLocalDate.isAfter(LocalDate.now())) {
                        datePickerTuNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant()));
                    }
                }
            }
        };
        datePickerTuNgay.addPropertyChangeListener(dateListenerTuNgay);

        JLabel lblDenNgay = new JLabel("ƒê·∫øn ng√†y:");
        lblDenNgay.setFont(fontLabel);
        datePickerDenNgay = new JXDatePicker();
        datePickerDenNgay.setFont(fontInput);
        datePickerDenNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant())); // M·∫∑c ƒë·ªãnh h√¥m nay

        // NgƒÉn ch·ªçn ng√†y l·ªõn h∆°n ng√†y hi·ªán t·∫°i
        PropertyChangeListener dateListenerDenNgay = evt -> {
            if ("date".equals(evt.getPropertyName())) {
                java.util.Date selectedDate = (java.util.Date) evt.getNewValue();
                if (selectedDate != null) {
                    LocalDate selectedLocalDate = LocalDate.ofInstant(selectedDate.toInstant(), java.time.ZoneId.systemDefault());
                    if (selectedLocalDate.isAfter(LocalDate.now())) {
                        datePickerDenNgay.setDate(java.util.Date.from(LocalDate.now().atStartOfDay(java.time.ZoneId.systemDefault()).toInstant()));
                    }
                }
            }
        };
        datePickerDenNgay.addPropertyChangeListener(dateListenerDenNgay);

        JLabel lblLoai = new JLabel("Lo·∫°i th·ªëng k√™:");
        lblLoai.setFont(fontLabel);
        String[] arrLoai = {"Theo ng√†y", "Theo th√°ng", "Theo qu√Ω", "Theo nƒÉm"};
        cmbLoaiThongKe = new JComboBox<>(arrLoai);
        cmbLoaiThongKe.setFont(fontInput);
        cmbLoaiThongKe.setPreferredSize(new Dimension(120, 30));
        cmbLoaiThongKe.addActionListener(e -> {
            String loai = (String) cmbLoaiThongKe.getSelectedItem();
            boolean isTheoNgay = "Theo ng√†y".equals(loai);
            boolean isTheoThang = "Theo th√°ng".equals(loai);
            boolean isTheoQuy = "Theo qu√Ω".equals(loai);
            boolean isTheoNam = "Theo nƒÉm".equals(loai);

            lblTuNgay.setVisible(isTheoNgay);
            datePickerTuNgay.setVisible(isTheoNgay);
            lblDenNgay.setVisible(isTheoNgay);
            datePickerDenNgay.setVisible(isTheoNgay);

            lblTuThang.setVisible(isTheoThang);
            cmbTuThang.setVisible(isTheoThang);
            lblDenThang.setVisible(isTheoThang);
            cmbDenThang.setVisible(isTheoThang);

            lblTuQuy.setVisible(isTheoQuy);
            cmbTuQuy.setVisible(isTheoQuy);
            lblDenQuy.setVisible(isTheoQuy);
            cmbDenQuy.setVisible(isTheoQuy);

            lblTuNam.setVisible(isTheoNam);
            cmbTuNam.setVisible(isTheoNam);
            lblDenNam.setVisible(isTheoNam);
            cmbDenNam.setVisible(isTheoNam);

            pnlFilter.revalidate();
            pnlFilter.repaint();

            // üëâ Reset table v√† t·ªïng doanh thu
            model.setRowCount(0);
            lblTongDoanhThu.setText("T·ªïng doanh thu: 0 VND");
        });

        // M·∫∑c ƒë·ªãnh ch·ªçn "Theo ng√†y" v√† hi·ªán JDatePicker
        // cmbLoaiThongKe.setSelectedItem("Theo ng√†y");
        // lblTuNgay.setVisible(true);
        // datePickerTuNgay.setVisible(true);
        // lblDenNgay.setVisible(true);
        // datePickerDenNgay.setVisible(true);

        // T·∫°o combo th√°ng
        cmbTuThang = new JComboBox<>();
        for (int i = 1; i <= 12; i++) cmbTuThang.addItem(i);
        cmbTuThang.setFont(fontInput);
        cmbTuThang.setPreferredSize(new Dimension(80, 30));

        cmbDenThang = new JComboBox<>();
        for (int i = 1; i <= 12; i++) cmbDenThang.addItem(i);
        cmbDenThang.setFont(fontInput);
        cmbDenThang.setPreferredSize(new Dimension(80, 30));

        // T·∫°o combo qu√Ω
        cmbTuQuy = new JComboBox<>();
        for (int i = 1; i <= 4; i++) cmbTuQuy.addItem(i);
        cmbTuQuy.setFont(fontInput);
        cmbTuQuy.setPreferredSize(new Dimension(80, 30));

        cmbDenQuy = new JComboBox<>();
        for (int i = 1; i <= 4; i++) cmbDenQuy.addItem(i);
        cmbDenQuy.setFont(fontInput);
        cmbDenQuy.setPreferredSize(new Dimension(80, 30));

        int minYear = 2025;
        int maxYear = LocalDate.now().getYear();
        cmbTuNam = new JComboBox<>();
        for (int i = minYear; i <= maxYear; i++) cmbTuNam.addItem(i);
        cmbTuNam.setFont(fontInput);
        cmbTuNam.setPreferredSize(new Dimension(80, 30));

        cmbDenNam = new JComboBox<>();
        for (int i = minYear; i <= maxYear; i++) cmbDenNam.addItem(i);
        cmbDenNam.setFont(fontInput);
        cmbDenNam.setPreferredSize(new Dimension(80, 30));

        // ·∫®n t·∫•t c·∫£ ban ƒë·∫ßu
        datePickerTuNgay.setVisible(false);
        datePickerDenNgay.setVisible(false);
        cmbTuThang.setVisible(false);
        cmbDenThang.setVisible(false);
        cmbTuQuy.setVisible(false);
        cmbDenQuy.setVisible(false);
        cmbTuNam.setVisible(false);
        cmbDenNam.setVisible(false);

        btnXemBaoCao = new JButton("Xem b√°o c√°o");
        btnXemBaoCao.setFont(fontLabel);
        btnXemBaoCao.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                xemBaoCao();
            }
        });

        btnXuatFile = new JButton("Xu·∫•t file b√°o c√°o");
        btnXuatFile.setFont(fontLabel);
        btnXuatFile.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                JFileChooser fileChooser = new JFileChooser();
                fileChooser.setDialogTitle("Ch·ªçn n∆°i l∆∞u b√°o c√°o Excel");
                fileChooser.setSelectedFile(new File("BaoCao.xlsx"));
                int userSelection = fileChooser.showSaveDialog(null);

                if (userSelection == JFileChooser.APPROVE_OPTION) {
                    File fileToSave = fileChooser.getSelectedFile();
                    // G·ªçi ph∆∞∆°ng th·ª©c xu·∫•t b√°o c√°o
                    xuatFileBaoCao(fileToSave);
                }

            }
        });
        // TODO: Th√™m logic xu·∫•t file sau

        pnlFilter.add(lblTuNgay);
        pnlFilter.add(datePickerTuNgay);
        pnlFilter.add(lblDenNgay);
        pnlFilter.add(datePickerDenNgay);
        
        pnlFilter.add(lblTuThang);
        pnlFilter.add(cmbTuThang);
        pnlFilter.add(lblDenThang);
        pnlFilter.add(cmbDenThang);

        pnlFilter.add(lblTuQuy);
        pnlFilter.add(cmbTuQuy);
        pnlFilter.add(lblDenQuy);
        pnlFilter.add(cmbDenQuy);

        pnlFilter.add(lblTuNam);
        pnlFilter.add(cmbTuNam);
        pnlFilter.add(lblDenNam);
        pnlFilter.add(cmbDenNam);
        
        pnlFilter.add(lblLoai);
        pnlFilter.add(cmbLoaiThongKe);
        pnlFilter.add(btnXemBaoCao);
        pnlFilter.add(btnXuatFile);

        pnlNorth.add(pnlFilter, BorderLayout.CENTER);

        // Panel CENTER (Table)
        pnlCenter = new JPanel(new BorderLayout());
        String[] columnNames = {"Th·ªùi gian", "T·ªïng h√≥a ƒë∆°n", "T·ªïng phi·∫øu tr·∫£", "Doanh thu"};
        model = new DefaultTableModel(columnNames, 0);
        table = new JTable(model);
        table.setFont(new Font("Arial", Font.PLAIN, 14));
        table.getTableHeader().setFont(new Font("Arial", Font.BOLD, 14));
        scrollPane = new JScrollPane(table);
        pnlCenter.add(scrollPane, BorderLayout.CENTER);

        // Panel SOUTH (T·ªïng doanh thu)
        JPanel pnlSouth = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        lblTongDoanhThu = new JLabel("T·ªïng doanh thu: 0 VND");
        lblTongDoanhThu.setFont(new Font("Arial", Font.BOLD, 16));
        pnlSouth.add(lblTongDoanhThu);

        // Th√™m v√†o main panel
        this.add(pnlNorth, BorderLayout.NORTH);
        this.add(pnlCenter, BorderLayout.CENTER);
        this.add(pnlSouth, BorderLayout.SOUTH);

        // X√≥a c√°c component c≈© n·∫øu c√≥

        // M·∫∑c ƒë·ªãnh ch·ªçn "Theo ng√†y" v√† hi·ªán JDatePicker
        cmbLoaiThongKe.setSelectedItem("Theo ng√†y");
        lblTuNgay.setVisible(true);
        datePickerTuNgay.setVisible(true);
        lblDenNgay.setVisible(true);
        datePickerDenNgay.setVisible(true);
    }

    private void xemBaoCao() {
        // Show loading
        showLoadingDialog();

        SwingWorker<Void, Void> worker = new SwingWorker<>() {
            @Override
            protected Void doInBackground() throws Exception {
                try {
                    String loaiThongKe = (String) cmbLoaiThongKe.getSelectedItem();

                    // Query DB
                    HoaDonDAO hoaDonDAO = new HoaDonDAO();
                    PhieuTraHangDAO phieuTraDAO = new PhieuTraHangDAO();

                    ArrayList<HoaDon> hoaDons = hoaDonDAO.getAllHoaDon();
                    ArrayList<PhieuTraHang> phieuTras = phieuTraDAO.getAllPhieuTraHang();

                    // T·∫°o list t·∫•t c·∫£ kho·∫£ng th·ªùi gian trong range
                    List<String> allKeys = new ArrayList<>();
                    if ("Theo ng√†y".equals(loaiThongKe)) {
                        Date tuNgay = datePickerTuNgay.getDate();
                        Date denNgay = datePickerDenNgay.getDate();
                        if(tuNgay.after(denNgay)){
                            JOptionPane.showMessageDialog(null, "T·ª´ ng√†y ph·∫£i b√© h∆°n ƒë·∫øn ng√†y");
                            return null;
                        }
                        LocalDate startDate = tuNgay.toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                        LocalDate endDate = denNgay.toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();
                        for (LocalDate date = startDate; !date.isAfter(endDate); date = date.plusDays(1)) {
                            allKeys.add(date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy")));
                        }
                    } else if ("Theo th√°ng".equals(loaiThongKe)) {
                        int tuThang = (Integer) cmbTuThang.getSelectedItem();
                        int tuNam = (Integer) cmbTuNam.getSelectedItem();
                        int denThang = (Integer) cmbDenThang.getSelectedItem();
                        int denNam = (Integer) cmbDenNam.getSelectedItem();
                        if(tuThang>denThang){
                            JOptionPane.showMessageDialog(null, "T·ª´ nƒÉm ph·∫£i b√© h∆°n ƒë·∫øn nƒÉm");
                            return null;
                        }
                        for (int nam = tuNam; nam <= denNam; nam++) {
                            int startThang = (nam == tuNam) ? tuThang : 1;
                            int endThang = (nam == denNam) ? denThang : 12;
                            for (int thang = startThang; thang <= endThang; thang++) {
                                allKeys.add(String.format("%02d/%d", thang, nam));
                            }
                        }
                    } else if ("Theo qu√Ω".equals(loaiThongKe)) {
                        int tuQuy = (Integer) cmbTuQuy.getSelectedItem();
                        int tuNam = (Integer) cmbTuNam.getSelectedItem();
                        int denQuy = (Integer) cmbDenQuy.getSelectedItem();
                        int denNam = (Integer) cmbDenNam.getSelectedItem();
                        if(tuQuy>denQuy){
                            JOptionPane.showMessageDialog(null, "T·ª´ qu√Ω ph·∫£i b√© h∆°n ƒë·∫øn qu√Ω");
                            return null;
                        }
                        for (int nam = tuNam; nam <= denNam; nam++) {
                            int startQuy = (nam == tuNam) ? tuQuy : 1;
                            int endQuy = (nam == denNam) ? denQuy : 4;
                            for (int quy = startQuy; quy <= endQuy; quy++) {
                                allKeys.add("Qu√Ω " + quy + " nƒÉm " + nam);
                            }
                        }
                    } else if ("Theo nƒÉm".equals(loaiThongKe)) {
                        int tuNam = (Integer) cmbTuNam.getSelectedItem();
                        int denNam = (Integer) cmbDenNam.getSelectedItem();
                        if(tuNam>denNam){
                            JOptionPane.showMessageDialog(null, "T·ª´ nƒÉm ph·∫£i b√© h∆°n ƒë·∫øn nƒÉm");
                            return null;
                        }
                        for (int nam = tuNam; nam <= denNam; nam++) {
                            allKeys.add("NƒÉm " + nam);
                        }
                    }

                    // T√≠nh doanh thu v√† c·∫≠p nh·∫≠t table
                    model.setRowCount(0);
                    double tongDoanhThu = 0;

                    for (String key : allKeys) {
                        double tongHD = hoaDons.stream()
                            .filter(hd -> getKey(hd, loaiThongKe).equals(key))
                            .mapToDouble(HoaDon::getTongTien)
                            .sum();
                        double tongPT = phieuTras.stream()
                            .filter(pt -> getKey(pt, loaiThongKe).equals(key))
                            .mapToDouble(PhieuTraHang::getTongTienHoanTra)
                            .sum();
                        double doanhThu = tongHD - tongPT;
                        model.addRow(new Object[]{key, dinhDangTien(tongHD), dinhDangTien(tongPT), dinhDangTien(doanhThu)});
                        tongDoanhThu += doanhThu;
                    }

                    lblTongDoanhThu.setText("T·ªïng doanh thu: " + dinhDangTien(tongDoanhThu));
                } catch (Exception e) {
                    JOptionPane.showMessageDialog(null, "L·ªói khi xem b√°o c√°o: " + e.getMessage(), "L·ªói", JOptionPane.ERROR_MESSAGE);
                }
                return null;
            }

            @Override
            protected void done() {
                // Hide loading
                disposeLoadingDialog();
            }
        };

        worker.execute();
    }

    // ƒê·ªãnh d·∫°ng ti·ªÅn nh∆∞ TraHangGUI
    private String dinhDangTien(double thanhTien) {
        DecimalFormat formatter = new DecimalFormat("#,###");
        return formatter.format(thanhTien) + " VNƒê";
    }

    // Get key cho HoaDon ho·∫∑c PhieuTraHang
    private String getKey(HoaDon hd, String loaiThongKe) {
        LocalDate date = hd.getNgayLapHoaDon().toLocalDate();
        if ("Theo ng√†y".equals(loaiThongKe)) {
            return date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy"));
        } else if ("Theo th√°ng".equals(loaiThongKe)) {
            return String.format("%02d/%d", date.getMonthValue(), date.getYear());
        } else if ("Theo qu√Ω".equals(loaiThongKe)) {
            int quy = (date.getMonthValue() - 1) / 3 + 1;
            return "Qu√Ω " + quy + " nƒÉm " + date.getYear();
        } else if ("Theo nƒÉm".equals(loaiThongKe)) {
            return "NƒÉm " + date.getYear();
        }
        return "";
    }

    private String getKey(PhieuTraHang pt, String loaiThongKe) {
        LocalDate date = pt.getNgayLapPhieuTraHang().toLocalDate();
        if ("Theo ng√†y".equals(loaiThongKe)) {
            return date.format(DateTimeFormatter.ofPattern("dd/MM/yyyy"));
        } else if ("Theo th√°ng".equals(loaiThongKe)) {
            return String.format("%02d/%d", date.getMonthValue(), date.getYear());
        } else if ("Theo qu√Ω".equals(loaiThongKe)) {
            int quy = (date.getMonthValue() - 1) / 3 + 1;
            return "Qu√Ω " + quy + " nƒÉm " + date.getYear();
        } else if ("Theo nƒÉm".equals(loaiThongKe)) {
            return "NƒÉm " + date.getYear();
        }
        return "";
    }

    private JDialog loadingDialog;

    private void showLoadingDialog() {
        loadingDialog = new JDialog(
            (java.awt.Frame) SwingUtilities.getWindowAncestor(this),
            "ƒêang t·∫£i", 
            false
        );
        loadingDialog.setDefaultCloseOperation(JDialog.DO_NOTHING_ON_CLOSE);

        // Panel ch·ª©a label + progress bar
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        JLabel label = new JLabel("ƒêang th·ªëng k√™ d·ªØ li·ªáu...", SwingConstants.CENTER);
        label.setFont(new Font("Arial", Font.BOLD, 14));
        panel.add(label, BorderLayout.NORTH);

        // Thanh loading
        JProgressBar progressBar = new JProgressBar();
        progressBar.setIndeterminate(true); // ch·∫°y qua l·∫°i
        panel.add(progressBar, BorderLayout.CENTER);

        loadingDialog.getContentPane().add(panel);
        loadingDialog.pack(); // t·ª± ƒë·ªông t√≠nh k√≠ch th∆∞·ªõc
        loadingDialog.setLocationRelativeTo(this);

        this.setEnabled(false);
        loadingDialog.setVisible(true);
    }

    private void disposeLoadingDialog() {
        if (loadingDialog != null) {
            loadingDialog.dispose();
            loadingDialog = null;
        }
        this.setEnabled(true);
    }
    
    private void xuatFileBaoCao(File fileToSave) {
    try (Workbook workbook = new XSSFWorkbook()) {
        Sheet sheet = workbook.createSheet("B√°o c√°o");

        String loaiThongKe = (String) cmbLoaiThongKe.getSelectedItem();

        // Header
        Row headerRow = sheet.createRow(0);
        Cell headerCell = headerRow.createCell(0);
        headerCell.setCellValue("B√ÅO C√ÅO DOANH THU " + loaiThongKe.toUpperCase());
        CellStyle headerStyle = workbook.createCellStyle();
        org.apache.poi.ss.usermodel.Font headerFont = workbook.createFont();
        headerFont.setBold(true);
        headerFont.setFontHeightInPoints((short) 16);
        headerStyle.setFont(headerFont);
        headerStyle.setAlignment(HorizontalAlignment.CENTER);
        headerCell.setCellStyle(headerStyle);
        sheet.addMergedRegion(new CellRangeAddress(0, 0, 0, model.getColumnCount()-1));


        // Th√¥ng tin filter (linh ƒë·ªông theo ng√†y/th√°ng/qu√Ω/nƒÉm)
        Row infoRow = sheet.createRow(2);
        Cell infoCell = infoRow.createCell(0);
            if ("Theo th√°ng".equals(loaiThongKe)) {
                int tuThang = (Integer) cmbTuThang.getSelectedItem();
                int tuNam = (Integer) cmbTuNam.getSelectedItem();
                int denThang = (Integer) cmbDenThang.getSelectedItem();
                int denNam = (Integer) cmbDenNam.getSelectedItem();
                infoCell.setCellValue("T·ª´ th√°ng " + tuThang + "/" + tuNam + " ƒë·∫øn th√°ng " + denThang + "/" + denNam);
            } else if ("Theo qu√Ω".equals(loaiThongKe)) {
                // t∆∞∆°ng t·ª± cho qu√Ω
            } else if ("Theo nƒÉm".equals(loaiThongKe)) {
                // t∆∞∆°ng t·ª± cho nƒÉm
            } else if ("Theo ng√†y".equals(loaiThongKe)) {
                // t∆∞∆°ng t·ª± cho ng√†y
            }
            sheet.addMergedRegion(new CellRangeAddress(2, 2, 0, model.getColumnCount()-1));

            // Th·ªùi gian l·∫≠p b√°o c√°o
            Row timeRow = sheet.createRow(3);
            Cell timeCell = timeRow.createCell(0);
            String ngayLap = java.time.LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"));
            timeCell.setCellValue("Th·ªùi gian l·∫≠p b√°o c√°o: " + ngayLap);
            sheet.addMergedRegion(new CellRangeAddress(3, 3, 0, model.getColumnCount()-1));

            // T·∫°o style border
            CellStyle borderStyle = workbook.createCellStyle();
            borderStyle.setBorderTop(BorderStyle.THIN);
            borderStyle.setBorderBottom(BorderStyle.THIN);
            borderStyle.setBorderLeft(BorderStyle.THIN);
            borderStyle.setBorderRight(BorderStyle.THIN);

            // Header b·∫£ng
            Row tableHeaderRow = sheet.createRow(5);
            for (int i = 0; i < model.getColumnCount(); i++) {
                Cell cell = tableHeaderRow.createCell(i);
                cell.setCellValue(model.getColumnName(i));
                cell.setCellStyle(borderStyle); // √°p d·ª•ng border
            }

            // D·ªØ li·ªáu b·∫£ng
            for (int r = 0; r < model.getRowCount(); r++) {
                Row row = sheet.createRow(r + 6);
                for (int c = 0; c < model.getColumnCount(); c++) {
                    Object value = model.getValueAt(r, c);
                    Cell cell = row.createCell(c);
                    cell.setCellValue(value != null ? value.toString() : "");
                    cell.setCellStyle(borderStyle); // √°p d·ª•ng border
                }
            }
            
            

            // Footer: t·ªïng doanh thu
            int footerRowIndex = model.getRowCount() + 7;
            Row footerRow = sheet.createRow(footerRowIndex);
            Cell footerCell = footerRow.createCell(0);
            footerCell.setCellValue(lblTongDoanhThu.getText());
            sheet.addMergedRegion(new CellRangeAddress(footerRowIndex, footerRowIndex, 0, model.getColumnCount()-1));

            // Auto resize
            for (int i = 0; i < model.getColumnCount(); i++) {
                sheet.autoSizeColumn(i);
            }

            try (FileOutputStream fos = new FileOutputStream(fileToSave)) {
                workbook.write(fos);
            }

            JOptionPane.showMessageDialog(this, "Xu·∫•t b√°o c√°o th√†nh c√¥ng: " + fileToSave.getAbsolutePath());
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "L·ªói khi xu·∫•t file: " + ex.getMessage(), "L·ªói", JOptionPane.ERROR_MESSAGE);
        }
    }
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables
}
